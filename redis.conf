# ============================================
# REDIS CONFIGURATION - PRODUCTION SECURE
# ============================================
# Para Hetzner VPS - Localhost apenas
# Elimina qualquer scan de rede

# ============================================
# NETWORK - LOCALHOST APENAS
# ============================================
bind 127.0.0.1 ::1
# CRÍTICO: Apenas localhost, NUNCA 0.0.0.0

protected-mode yes
# CRÍTICO: Proteção ativa

port 6379
# Porta padrão, mas apenas localhost

tcp-backlog 511
timeout 0
tcp-keepalive 300

# ============================================
# SEGURANÇA
# ============================================
# GERE UMA SENHA FORTE:
# openssl rand -base64 32
requirepass "x+vOJPfIyT2aCpYApDpvDnqCTa7fBqqpGombI8ybKKc="

# Desabilitar comandos perigosos
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command CONFIG ""
rename-command SHUTDOWN ""
rename-command BGREWRITEAOF ""
rename-command BGSAVE ""
rename-command SAVE ""
rename-command DEBUG ""

# ============================================
# MEMÓRIA
# ============================================
maxmemory 512mb
# Ajuste conforme RAM disponível

maxmemory-policy noeviction
# IMPORTANTE: noeviction para BullMQ
# Não remove keys automaticamente quando memória cheia
# Retorna erro em vez de deletar dados importantes
# Recomendado para sistemas de filas

# ============================================
# PERSISTÊNCIA
# ============================================
# RDB Snapshots
save 900 1
save 300 10
save 60 10000

stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /var/lib/redis

# AOF (mais seguro para filas)
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# ============================================
# LOGGING
# ============================================
loglevel notice
logfile /var/log/redis/redis-server.log
syslog-enabled no

# ============================================
# PERFORMANCE
# ============================================
databases 16
# BullMQ usa db 0 por padrão

# Disable slow log para evitar overhead
slowlog-log-slower-than 10000
slowlog-max-len 128

# ============================================
# REPLICAÇÃO (Desabilitado)
# ============================================
# Não usar replicação em produção simples
# Se precisar, configure master/slave separadamente

# ============================================
# CLUSTER (Desabilitado)
# ============================================
# cluster-enabled no
# Não usar cluster mode

# ============================================
# LIMITES
# ============================================
maxclients 10000
# Limite de conexões simultâneas

# ============================================
# LATENCY MONITOR
# ============================================
latency-monitor-threshold 100
# Monitor latência > 100ms

# ============================================
# DESABILITAR RECURSOS DESNECESSÁRIOS
# ============================================
# Desabilitar Lua scripting timeout (BullMQ precisa)
lua-time-limit 5000

# Desabilitar notificações de keyspace (não usado)
notify-keyspace-events ""

# ============================================
# SEGURANÇA ADICIONAL
# ============================================
# Desabilitar comandos de admin via rede
# (já feito com rename-command acima)

# Não permitir conexões de IPs externos
# (já garantido com bind 127.0.0.1)

# ============================================
# NOTAS IMPORTANTES
# ============================================
# 1. SEMPRE use senha forte (requirepass)
# 2. NUNCA exponha Redis para internet
# 3. Use firewall para bloquear porta 6379
# 4. Monitore logs regularmente
# 5. Faça backup do dump.rdb e appendonly.aof
# 6. Teste conexão: redis-cli -a YOUR_PASSWORD ping
# 7. Verifique bind: netstat -tlnp | grep 6379
#    Deve mostrar apenas 127.0.0.1:6379
